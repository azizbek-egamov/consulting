{% extends 'base.html' %}
{% load static %}

{% block title %}Yangi Lead{% endblock title %}

{% block item %}
<div class="app-body">
    {% include 'messages.html' %}
    <div class="row gx-3">
        <div class="col-sm-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Yangi Lead Qo'shish</h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <div class="row g-3">
                            <!-- Telefon raqami -->
                            <div class="col-md-6">
                                <label class="form-label">Telefon raqami <span class="text-danger">*</span></label>
                                <input type="text" name="phone_number" id="phoneInput" class="form-control" 
                                       placeholder="+998 XX XXX XX XX" required>
                                <div class="form-text">Telefon raqamni to'liq kiriting</div>
                            </div>
                            
                            <!-- Mijoz ismi -->
                            <div class="col-md-6">
                                <label class="form-label">Mijoz ismi</label>
                                <input type="text" name="client_name" class="form-control" 
                                       placeholder="Mijoz ismini kiriting">
                            </div>
                            
                            <!-- Qo'ng'iroq holati -->
                            <div class="col-md-6">
                                <label class="form-label">Qo'ng'iroq holati <span class="text-danger">*</span></label>
                                <select name="call_status" class="form-select" required>
                                    <option value="">Holatni tanlang</option>
                                    {% for status_code, status_name in status_choices %}
                                        <option value="{{ status_code }}">{{ status_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <!-- Qo'ng'iroq davomiyligi -->
                            <div class="col-md-6">
                                <label class="form-label">Qo'ng'iroq davomiyligi</label>
                                <div class="row g-2">
                                    <div class="col-4">
                                        <input type="number" id="hours" class="form-control" 
                                               placeholder="Soat" min="0" max="23" value="0">
                                        <small class="text-muted">Soat</small>
                                    </div>
                                    <div class="col-4">
                                        <input type="number" id="minutes" class="form-control" 
                                               placeholder="Daqiqa" min="0" max="59" value="0">
                                        <small class="text-muted">Daqiqa</small>
                                    </div>
                                    <div class="col-4">
                                        <input type="number" id="seconds" class="form-control" 
                                               placeholder="Soniya" min="0" max="59" value="0">
                                        <small class="text-muted">Soniya</small>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <label class="form-label">Yoki to'g'ridan-to'g'ri kiriting:</label>
                                    <input type="text" name="duration_input" id="durationInput" class="form-control" 
                                           placeholder="00:05:30 yoki 000530">
                                    <small class="text-muted">Format: HH:MM:SS yoki HHMMSS</small>
                                </div>
                            </div>
                            
                            <!-- Audio yozuv -->
                            <div class="col-md-6">
                                <label class="form-label">Audio yozuv</label>
                                <input type="file" name="audio_recording" class="form-control" 
                                       accept="audio/*">
                                <div class="form-text">MP3, WAV, M4A formatlarini qo'llab-quvvatlaydi</div>
                            </div>
                            
                            <!-- Keyingi qo'ng'iroq -->
                            <div class="col-md-6">
                                <label class="form-label">Keyingi qo'ng'iroq</label>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <input type="date" name="follow_up_date" class="form-control">
                                    </div>
                                    <div class="col-6">
                                        <input type="time" name="follow_up_time" class="form-control">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Izohlar -->
                            <div class="col-12">
                                <label class="form-label">Izohlar</label>
                                <textarea name="notes" class="form-control" rows="4" 
                                          placeholder="Qo'ng'iroq haqida qo'shimcha ma'lumotlar..."></textarea>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="ri-save-line me-1"></i>Saqlash
                            </button>
                            <a href="{% url 'leads_list' %}" class="btn btn-secondary">
                                <i class="ri-arrow-left-line me-1"></i>Orqaga
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const phoneInput = document.getElementById('phoneInput');
    const hoursInput = document.getElementById('hours');
    const minutesInput = document.getElementById('minutes');
    const secondsInput = document.getElementById('seconds');
    const durationInput = document.getElementById('durationInput');
    
    // Telefon raqam formatlashtirish
    phoneInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        
        // +998 ni avtomatik qo'shish
        if (!value.startsWith('998')) {
            if (value.length === 0) {
                value = '998';
            } else if (value.length < 3) {
                value = '998';
            } else if (!value.startsWith('998')) {
                value = '998' + value;
            }
        }
        
        // Formatlashtirish: +998 XX XXX XX XX
        let formatted = '+998';
        if (value.length > 3) {
            formatted += ' ' + value.substring(3, 5);
        }
        if (value.length > 5) {
            formatted += ' ' + value.substring(5, 8);
        }
        if (value.length > 8) {
            formatted += ' ' + value.substring(8, 10);
        }
        if (value.length > 10) {
            formatted += ' ' + value.substring(10, 12);
        }
        
        e.target.value = formatted;
    });
    
    // Telefon raqamni backspace bilan o'chirishda +998 ni saqlash
    phoneInput.addEventListener('keydown', function(e) {
        if (e.key === 'Backspace' && e.target.value.length <= 4) {
            e.preventDefault();
            e.target.value = '+998';
        }
    });
    
    // Boshlang'ich qiymat
    if (phoneInput.value === '') {
        phoneInput.value = '+998';
    }
    
    // Davomiylik formatlashtirish
    function updateDurationInput() {
        const hours = parseInt(hoursInput.value) || 0;
        const minutes = parseInt(minutesInput.value) || 0;
        const seconds = parseInt(secondsInput.value) || 0;
        
        const formatted = String(hours).padStart(2, '0') + ':' + 
                         String(minutes).padStart(2, '0') + ':' + 
                         String(seconds).padStart(2, '0');
        
        durationInput.value = formatted;
    }
    
    // Alohida inputlar o'zgarganda
    hoursInput.addEventListener('input', updateDurationInput);
    minutesInput.addEventListener('input', updateDurationInput);
    secondsInput.addEventListener('input', updateDurationInput);
    
    // To'g'ridan-to'g'ri kiritish
    durationInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        
        if (value.length === 6) {
            // HHMMSS format
            const hours = value.substring(0, 2);
            const minutes = value.substring(2, 4);
            const seconds = value.substring(4, 6);
            
            e.target.value = hours + ':' + minutes + ':' + seconds;
            
            // Alohida inputlarni yangilash
            hoursInput.value = parseInt(hours);
            minutesInput.value = parseInt(minutes);
            secondsInput.value = parseInt(seconds);
        } else if (value.length <= 6) {
            // Avtomatik formatlashtirish
            if (value.length >= 2) {
                let formatted = value.substring(0, 2);
                if (value.length >= 4) {
                    formatted += ':' + value.substring(2, 4);
                    if (value.length === 6) {
                        formatted += ':' + value.substring(4, 6);
                    }
                }
                e.target.value = formatted;
            }
        }
    });
    
    // Davomiylik inputini HH:MM:SS formatida saqlash
    durationInput.addEventListener('blur', function(e) {
        const value = e.target.value;
        if (value && value.includes(':')) {
            const parts = value.split(':');
            if (parts.length >= 2) {
                const hours = parseInt(parts[0]) || 0;
                const minutes = parseInt(parts[1]) || 0;
                const seconds = parseInt(parts[2]) || 0;
                
                hoursInput.value = hours;
                minutesInput.value = minutes;
                secondsInput.value = seconds;
                
                e.target.value = String(hours).padStart(2, '0') + ':' + 
                               String(minutes).padStart(2, '0') + ':' + 
                               String(seconds).padStart(2, '0');
            }
        }
    });
});
</script>
{% endblock item %}
