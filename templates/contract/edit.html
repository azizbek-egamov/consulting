{% extends "base.html" %}
{% block title %}Shartnomani tahrirlash{% endblock title %}

{% block item %}
<div class="app-container">
  <div class="app-hero-header d-flex align-items-center">
    <ol class="breadcrumb mb-0">
      <li class="breadcrumb-item">
        <i class="ri-home-8-line lh-1 pe-3 me-3 border-end"></i>
        <a href="/">Asosiy</a>
      </li>
      <li class="breadcrumb-item">
        <a href="{% url 'contract' %}">Shartnomalar</a>
      </li>
      <li class="breadcrumb-item text-primary">Shartnomani tahrirlash</li>
    </ol>
  </div>

  <div class="app-body">
    {% include 'messages.html' %}

        <div class="card shadow-sm border-0">
      <div class="card-header bg-white">
        <h5 class="mb-0 d-flex align-items-center">
          <i class="ri-edit-2-line me-2 text-primary"></i>
          #{{ contract.contract_number }} shartnomasi
            </h5>
          </div>
          
      <form method="post" class="card-body" enctype="multipart/form-data">
            {% csrf_token %}
        <div class="row g-4">
          <div class="col-12">
            <h6 class="text-uppercase text-muted mb-3">Shartnoma ma'lumotlari</h6>
                  <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Shartnoma raqami</label>
                <input type="text" class="form-control" value="{{ contract.contract_number }}" readonly style="background-color: #f8f9fa;">
                        </div>
              <div class="col-md-6">
                <label class="form-label">Shartnoma sanasi</label>
                <input type="text" class="form-control" value="{{ contract.contract_date|date:'d.m.Y' }}" readonly style="background-color: #f8f9fa;">
                      </div>
              <div class="col-md-12">
                <label class="form-label">Tuzilgan joy</label>
                <input type="text" name="contract_location" class="form-control" value="{{ contract.contract_location }}">
                      </div>
                    </div>
                  </div>
                  
          <div class="col-12">
            <h6 class="text-uppercase text-muted mb-3">Buyurtmachi ma'lumotlari</h6>
                    <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Ism <span class="text-danger">*</span></label>
                <input type="text" name="client_first_name" class="form-control" value="{% if client_info.first_name %}{{ client_info.first_name }}{% elif contract.client_first_name %}{{ contract.client_first_name }}{% endif %}" required>
                          </div>
              <div class="col-md-4">
                <label class="form-label">Familiya <span class="text-danger">*</span></label>
                <input type="text" name="client_last_name" class="form-control" value="{% if client_info.last_name %}{{ client_info.last_name }}{% elif contract.client_last_name %}{{ contract.client_last_name }}{% endif %}" required>
                          </div>
              <div class="col-md-4">
                <label class="form-label">Sharif</label>
                <input type="text" name="client_middle_name" class="form-control" value="{% if client_info.middle_name %}{{ client_info.middle_name }}{% elif contract.client_middle_name %}{{ contract.client_middle_name }}{% endif %}">
                          </div>
              <div class="col-md-4">
                <label class="form-label">Passport raqami <span class="text-danger">*</span></label>
                <input type="text" name="passport_number" class="form-control" value="{% if client_info.passport_number %}{{ client_info.passport_number }}{% else %}{{ contract.passport_number }}{% endif %}" required>
                          </div>
              <div class="col-md-4">
                <label class="form-label">Passport berilgan sana</label>
                <input type="text" name="passport_issue_date" class="form-control" value="{% if client_info.passport_issue_date and client_info.passport_issue_date != 'None' %}{{ client_info.passport_issue_date }}{% elif contract.passport_issue_date and contract.passport_issue_date != 'None' %}{{ contract.passport_issue_date }}{% endif %}" data-date-mask="true">
                        </div>
              <div class="col-md-4">
                <label class="form-label">Passport tugash sanasi</label>
                <input type="text" name="passport_expiry_date" class="form-control" value="{% if contract.passport_expiry_date and contract.passport_expiry_date != 'None' %}{{ contract.passport_expiry_date }}{% endif %}" data-date-mask="true">
              </div>
              <div class="col-md-4">
                <label class="form-label">Tug'ilgan sana</label>
                <input type="text" name="birth_date" class="form-control" placeholder="01.01.2000" data-date-mask="true" value="{% if client_info.birth_date %}{{ client_info.birth_date }}{% endif %}">
              </div>
              <div class="col-md-6">
                <label class="form-label">Passport bergan tashkilot</label>
                <input type="text" name="passport_issue_place" class="form-control" value="{% if client_info.passport_issue_place and client_info.passport_issue_place != 'None' %}{{ client_info.passport_issue_place }}{% elif contract.passport_issue_place and contract.passport_issue_place != 'None' %}{{ contract.passport_issue_place }}{% endif %}">
                      </div>
              <div class="col-md-6">
                <label class="form-label">Yashash manzili</label>
                <input type="text" name="client_address" class="form-control" value="{% if client_info.address and client_info.address != 'None' %}{{ client_info.address }}{% elif contract.client_address and contract.client_address != 'None' %}{{ contract.client_address }}{% endif %}">
                          </div>
              <div class="col-md-6">
                <label class="form-label">Telefon raqam <span class="text-danger">*</span></label>
                <input type="text" name="phone_primary" class="form-control" value="{% if client_info.phone %}{{ client_info.phone }}{% elif contract.phone_primary %}{{ contract.phone_primary }}{% endif %}" required>
                          </div>
              <div class="col-md-6">
                <label class="form-label">Qo'shimcha telefon</label>
                <input type="text" name="phone_secondary" class="form-control" value="{% if client_info.phone2 and client_info.phone2 != 'None' %}{{ client_info.phone2 }}{% elif contract.phone_secondary and contract.phone_secondary != 'None' %}{{ contract.phone_secondary }}{% endif %}">
                  </div>
              <div class="col-md-6">
                <label class="form-label">Qayerda eshitgan <span class="text-danger">*</span></label>
                <input type="text" name="heard" class="form-control" value="{% if client_info.heard %}{{ client_info.heard }}{% endif %}" placeholder="Masalan: Instagram, Telegram, tanishlar..." required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Elektron pochta</label>
                <input type="email" name="email" class="form-control" value="{% if client_info.email %}{{ client_info.email }}{% endif %}" placeholder="example@email.com">
              </div>
              <div class="col-md-6">
                <label class="form-label">Parol</label>
                <input type="text" name="password" class="form-control" value="{% if client_info.password %}{{ client_info.password }}{% endif %}" placeholder="Mijoz uchun parol">
              </div>
              <div class="col-md-12">
                <div class="row g-2 align-items-end">
                  <div class="col-md-6">
                    <label class="form-label">Zagran passport rasmi (1 ta)</label>
                    <div class="row g-2" id="passport-images-container">
                      {% if contract.passport_images %}
                        {% for img in contract.passport_images %}
                          <div class="col-12 passport-image-item">
                            <div class="d-flex align-items-center gap-2 mb-2">
                              {% if img|slice:"0:4" == "http" or img|slice:"0:5" == "https" %}
                                {% with img_url=img %}
                                  <img src="{{ img_url }}" alt="Passport" style="max-width: 100px; max-height: 100px; object-fit: cover;" class="img-thumbnail">
                                {% endwith %}
                              {% elif img|slice:"0:2" == "//" %}
                                {% with img_url="/"|add:img|slice:"2:" %}
                                  <img src="{{ img_url }}" alt="Passport" style="max-width: 100px; max-height: 100px; object-fit: cover;" class="img-thumbnail">
                                {% endwith %}
                              {% elif img|slice:"0:1" == "/" %}
                                {% with img_url=img %}
                                  <img src="{{ img_url }}" alt="Passport" style="max-width: 100px; max-height: 100px; object-fit: cover;" class="img-thumbnail">
                                {% endwith %}
                              {% else %}
                                {% with img_url="/"|add:img %}
                                  <img src="{{ img_url }}" alt="Passport" style="max-width: 100px; max-height: 100px; object-fit: cover;" class="img-thumbnail">
                                {% endwith %}
                              {% endif %}
                              <div>
                                <button type="button" class="btn btn-sm btn-danger remove-passport-image" data-index="{{ forloop.counter0 }}">O'chirish</button>
                                <input type="hidden" name="delete_passport_image" value="{{ forloop.counter0 }}" class="delete-passport-input" disabled>
                              </div>
                            </div>
                          </div>
                        {% endfor %}
                      {% endif %}
                      {% if contract.passport_images|length < 1 %}
                        <div class="col-12">
                          <input type="file" name="passport_image_0" class="form-control passport-image-input" accept="image/*">
                        </div>
                      {% endif %}
                    </div>
                    <small class="text-muted">Faqat bitta passport rasmini yuklang. Yangisini yuklasangiz eski rasmni o'chiring.</small>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">VISA rasmi (1 ta)</label>
                    <div class="row g-2" id="visa-images-container">
                      {% if contract.visa_images %}
                        {% for img in contract.visa_images %}
                          <div class="col-12 visa-image-item">
                            <div class="d-flex align-items-center gap-2 mb-2">
                              {% if img|slice:"0:4" == "http" or img|slice:"0:5" == "https" %}
                                {% with img_url=img %}
                                  <img src="{{ img_url }}" alt="Visa" style="max-width: 100px; max-height: 100px; object-fit: cover;" class="img-thumbnail">
                                {% endwith %}
                              {% elif img|slice:"0:2" == "//" %}
                                {% with img_url="/"|add:img|slice:"2:" %}
                                  <img src="{{ img_url }}" alt="Visa" style="max-width: 100px; max-height: 100px; object-fit: cover;" class="img-thumbnail">
                                {% endwith %}
                              {% elif img|slice:"0:1" == "/" %}
                                {% with img_url=img %}
                                  <img src="{{ img_url }}" alt="Visa" style="max-width: 100px; max-height: 100px; object-fit: cover;" class="img-thumbnail">
                                {% endwith %}
                              {% else %}
                                {% with img_url="/"|add:img %}
                                  <img src="{{ img_url }}" alt="Visa" style="max-width: 100px; max-height: 100px; object-fit: cover;" class="img-thumbnail">
                                {% endwith %}
                              {% endif %}
                              <div>
                                <button type="button" class="btn btn-sm btn-danger remove-visa-image" data-index="{{ forloop.counter0 }}">O'chirish</button>
                                <input type="hidden" name="delete_visa_image" value="{{ forloop.counter0 }}" class="delete-visa-input" disabled>
                              </div>
                            </div>
                          </div>
                        {% endfor %}
                      {% endif %}
                      {% if contract.visa_images|length < 1 %}
                        <div class="col-12">
                          <input type="file" name="visa_image_0" class="form-control visa-image-input" accept="image/*">
                        </div>
                      {% endif %}
                    </div>
                    <small class="text-muted">Yangi rasm yuklasangiz, mavjud VISA rasmi o'rnini bosadi.</small>
                  </div>
                </div>
              </div>
                </div>
              </div>

          <div class="col-12">
            <h6 class="text-uppercase text-muted mb-3">Ish yakunlanganidan keyingi shartnoma rasmlari</h6>
            <div class="row g-3">
              <div class="col-md-12">
                <label class="form-label">Shartnoma rasmlari (maksimal 3 ta)</label>
                <div class="row g-2" id="completed-contract-images-container">
                  {% if contract.completed_contract_images %}
                    {% for img in contract.completed_contract_images %}
                      <div class="col-md-4 completed-contract-image-item">
                        <div class="d-flex align-items-center gap-2 mb-2">
                          {# URL ni to'g'rilash: http(s) bo'lmasa bitta / bilan boshlansin #}
                          {% if img|slice:"0:4" == "http" or img|slice:"0:5" == "https" %}
                            {% with img_url=img %}
                              <img src="{{ img_url }}" alt="Shartnoma" style="max-width: 100px; max-height: 100px; object-fit: cover;" class="img-thumbnail">
                            {% endwith %}
                          {% elif img|slice:"0:2" == "//" %}
                            {% with img_url="/"|add:img|slice:"2:" %}
                              <img src="{{ img_url }}" alt="Shartnoma" style="max-width: 100px; max-height: 100px; object-fit: cover;" class="img-thumbnail">
                            {% endwith %}
                          {% elif img|slice:"0:1" == "/" %}
                            {% with img_url=img %}
                              <img src="{{ img_url }}" alt="Shartnoma" style="max-width: 100px; max-height: 100px; object-fit: cover;" class="img-thumbnail">
                            {% endwith %}
                          {% else %}
                            {% with img_url="/"|add:img %}
                              <img src="{{ img_url }}" alt="Shartnoma" style="max-width: 100px; max-height: 100px; object-fit: cover;" class="img-thumbnail">
                            {% endwith %}
                          {% endif %}
                          <div>
                            <button type="button" class="btn btn-sm btn-danger remove-completed-image" data-index="{{ forloop.counter0 }}">O'chirish</button>
                            <input type="hidden" name="delete_completed_contract_image" value="{{ forloop.counter0 }}" class="delete-completed-input" disabled>
                          </div>
                        </div>
                      </div>
                    {% endfor %}
                  {% endif %}
                  {% if contract.completed_contract_images|length < 3 %}
                    {% for i in "xxx"|ljust:3 %}
                      {% if forloop.counter0 >= contract.completed_contract_images|length %}
                        <div class="col-md-4">
                          <input type="file" name="completed_contract_image_{{ forloop.counter0 }}" class="form-control completed-contract-image-input" accept="image/*">
                        </div>
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                </div>
                <small class="text-muted">Hohlasa 1, 2 yoki 3 ta rasm yuklashingiz mumkin. Keyinchalik ham qo'shishingiz mumkin.</small>
              </div>
            </div>
          </div>
          
          <div class="col-12">
            <h6 class="text-uppercase text-muted mb-3">Ota-onasi / Farzandlari</h6>
            <div id="family-members-container">
              <!-- Family members will be added here dynamically -->
            </div>
            <div id="family-empty-placeholder" class="alert alert-light border d-none mt-2 mb-0">
              Ma'lumot topilmadi. "Qo'shish" tugmasi orqali qo'shing.
            </div>
            <div class="d-flex justify-content-end mt-2">
              <button type="button" class="btn btn-sm btn-primary" id="add-family-member">
                <i class="ri-add-line me-1"></i> Qo'shish
              </button>
            </div>
          </div>
              
          <div class="col-12">
            <h6 class="text-uppercase text-muted mb-3">Xizmat tafsilotlari</h6>
                      <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Xizmat nomi <span class="text-danger">*</span></label>
                <input type="text" name="service_name" class="form-control" value="{{ contract.service_name|default:'Angliya ishchi viza paketi' }}" placeholder="Angliya ishchi viza paketi" required>
                            </div>
              <div class="col-md-4">
                <label class="form-label">Visa turi / yo'nalish <span class="text-danger">*</span></label>
                <input type="text" name="visa_type" class="form-control" value="{{ contract.visa_type|default:'Ishchi viza' }}" placeholder="Ishchi viza" required>
                            </div>
              <div class="col-md-4">
                <label class="form-label">Davlat</label>
                <input type="text" name="service_country" class="form-control" value="{% if contract.service_country and contract.service_country != 'None' %}{{ contract.service_country }}{% endif %}">
                          </div>
              <div class="col-12">
                <label class="form-label">Xizmat tavsifi</label>
                <textarea name="service_description" class="form-control" rows="3">{% if contract.service_description and contract.service_description != 'None' %}{{ contract.service_description }}{% endif %}</textarea>
                        </div>
                    </div>
                  </div>
                  
          <div class="col-12">
            <h6 class="text-uppercase text-muted mb-3">To'lov ma'lumotlari</h6>
                  <div class="row g-3">
                    <div class="col-md-4">
                <label class="form-label">Umumiy xizmat summasi <span class="text-danger">*</span></label>
                <input type="text" name="total_service_fee" class="form-control money-input" value="{{ contract.total_service_fee }}" required>
                    </div>
                    <div class="col-md-4">
                <label class="form-label">Boshlang'ich to'lov <span class="text-danger">*</span></label>
                <input type="text" name="initial_payment_amount" class="form-control money-input" value="{{ contract.initial_payment_amount }}" required>
                    </div>
                    <div class="col-md-4">
                <label class="form-label">Boshlang'ich to'lov muddati (kun)</label>
                <input type="number" name="initial_payment_due_days" class="form-control" value="{{ contract.initial_payment_due_days }}">
                    </div>
                    <div class="col-md-4">
                <label class="form-label">Suhbatdan keyingi to'lov</label>
                <input type="text" name="post_interview_payment_amount" class="form-control money-input" value="{{ contract.post_interview_payment_amount }}" readonly>
                    </div>
                    <div class="col-md-4">
                <label class="form-label">Suhbatdan keyingi to'lov muddati (kun)</label>
                <input type="number" name="post_interview_due_days" class="form-control" value="{{ contract.post_interview_due_days }}">
                    </div>
                    <div class="col-md-4">
                <label class="form-label">Qaytariladigan summa</label>
                <input type="text" name="refund_amount" class="form-control money-input" value="{{ contract.refund_amount|default_if_none:'' }}">
                        </div>
                    <div class="col-md-4">
                <label class="form-label">Haqiqiy to'langan summa</label>
                <input type="text" name="amount_paid" class="form-control money-input" value="{{ contract.amount_paid|default_if_none:'' }}">
                    </div>
                    <div class="col-md-4">
                <label class="form-label">Xizmat davomiyligi (oy)</label>
                <input type="number" name="service_duration_months" class="form-control" value="{{ contract.service_duration_months }}">
                    </div>
                    <div class="col-md-4">
                <label class="form-label">Holat</label>
                <select name="status" class="form-select">
                  {% for value, label in status_choices %}
                  <option value="{{ value }}" {% if contract.status == value %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                          </select>
                      </div>
                    </div>
                  </div>

          <div class="col-12">
            <label class="form-label text-muted">Qo'shimcha izohlar</label>
            <textarea name="notes" class="form-control" rows="4">{% if contract.notes and contract.notes != 'None' %}{{ contract.notes }}{% endif %}</textarea>
              </div>
              
          <div class="col-12 d-flex justify-content-end gap-2">
            <a href="{% url 'contract' %}" class="btn btn-light">Bekor qilish</a>
            <button type="submit" class="btn btn-primary">Saqlash</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  // Remove "None" values from all input and textarea fields
  function removeNoneValues() {
    document.querySelectorAll('input[type="text"], input[type="number"], textarea').forEach(function(field) {
      if (field.value === 'None' || field.value === 'none' || field.value === 'null' || field.value === 'NULL') {
        field.value = '';
      }
    });
  }
  
  // Remove None values immediately
  removeNoneValues();
  
  // Also remove after a short delay to catch any dynamically loaded content
  setTimeout(removeNoneValues, 100);

  const moneyInputs = document.querySelectorAll(".money-input");
  const totalInput = document.querySelector('input[name="total_service_fee"]');
  const initialInput = document.querySelector('input[name="initial_payment_amount"]');
  const postInterviewInput = document.querySelector('input[name="post_interview_payment_amount"]');
  const contractNumberInput = document.querySelector('input[name="contract_number"]');
  const passportInput = document.querySelector('input[name="passport_number"]');

  function parseMoney(val) {
    if (val === null || val === undefined) return 0;
    const cleaned = String(val).replace(/\s+/g, "").replace(/,/g, "");
    if (!cleaned) return 0;
    return parseInt(cleaned, 10) || 0;
  }

  function formatMoney(val) {
    if (val === null || val === undefined) return "";
    const cleaned = String(val).replace(/\s+/g, "").replace(/,/g, "");
    if (!cleaned) return "";
    const n = parseInt(cleaned, 10);
    if (isNaN(n)) return "";
    return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
  }

  moneyInputs.forEach((input) => {
    input.addEventListener("input", () => {
      const pos = input.selectionStart || 0;
      input.value = formatMoney(input.value);
      if (input.value) {
        input.setSelectionRange(Math.min(pos, input.value.length), Math.min(pos, input.value.length));
      }
      autoFillPostInterview();
    });
    input.addEventListener("blur", () => {
      input.value = formatMoney(input.value);
      autoFillPostInterview();
    });
  });

  autoFillPostInterview();

  function autoFillPostInterview() {
    if (!totalInput || !initialInput || !postInterviewInput) return;
    const totalRaw = totalInput.value ? parseMoney(totalInput.value) : null;
    const initialRaw = initialInput.value ? parseMoney(initialInput.value) : null;
    if (totalRaw === null || initialRaw === null) {
      postInterviewInput.value = "";
      return;
    }
    const rest = Math.max(totalRaw - initialRaw, 0);
    postInterviewInput.value = formatMoney(rest);
  }

  // Passport: first 2 letters mandatory before digits
  if (passportInput) {
    passportInput.addEventListener("input", (e) => {
      let v = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, "");
      let letters = v.slice(0, 2).replace(/[^A-Z]/g, "");
      let digits = v.slice(2).replace(/\D/g, "");
      e.target.value = letters + digits;
    });
  }

  // Enforce contract number minimum on submit
  const form = document.querySelector("form");
  if (form && contractNumberInput && contractNumberInput.min) {
    form.addEventListener("submit", (e) => {
      const minVal = parseInt(contractNumberInput.min, 10) || 0;
      const current = parseInt(contractNumberInput.value || "0", 10);
      if (current < minVal) {
        e.preventDefault();
        alert(`Shartnoma raqami ${minVal} dan kichik bo'lishi mumkin emas.`);
      }
    });
  }

  // Family members management
  let familyMemberIndex = 0;
  const addFamilyMemberBtn = document.getElementById("add-family-member");
  const familyMembersContainer = document.getElementById("family-members-container");
  const familyEmptyPlaceholder = document.getElementById("family-empty-placeholder");

  function toggleFamilyPlaceholder() {
    if (!familyEmptyPlaceholder) return;
    const hasMembers = familyMembersContainer && familyMembersContainer.children.length > 0;
    familyEmptyPlaceholder.classList.toggle("d-none", hasMembers);
  }

  function addFamilyMember(data = {}) {
    const index = familyMemberIndex++;
    const memberCard = document.createElement("div");
    memberCard.className = "card mb-3 family-member-card";
    
    // Format birth date for display - endi CharField bo'lgani uchun to'g'ridan-to'g'ri ko'rsatamiz
    let birthDateDisplay = data.birth_date || '';
    
    memberCard.innerHTML = `
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="mb-0">Qarindosh #${index + 1}</h6>
          <button type="button" class="btn btn-sm btn-danger remove-family-member">
            <i class="ri-delete-bin-line"></i> O'chirish
          </button>
        </div>
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Ism <span class="text-danger">*</span></label>
            <input type="text" name="family_member_${index}_first_name" class="form-control" placeholder="Ism" value="${data.first_name || ''}" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Familiya <span class="text-danger">*</span></label>
            <input type="text" name="family_member_${index}_last_name" class="form-control" placeholder="Familiya" value="${data.last_name || ''}" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Sharif</label>
            <input type="text" name="family_member_${index}_middle_name" class="form-control" placeholder="Sharif" value="${data.middle_name || ''}">
          </div>
          <div class="col-md-3">
            <label class="form-label">Qarindoshlik darajasi <span class="text-danger">*</span></label>
            <select name="family_member_${index}_relationship" class="form-select">
              <option value="father" ${data.relationship === 'father' ? 'selected' : ''}>Ota</option>
              <option value="mother" ${data.relationship === 'mother' ? 'selected' : ''}>Ona</option>
              <option value="son" ${data.relationship === 'son' ? 'selected' : ''}>O'g'il</option>
              <option value="daughter" ${data.relationship === 'daughter' ? 'selected' : ''}>Qiz</option>
              <option value="spouse" ${data.relationship === 'spouse' ? 'selected' : ''}>Turmush o'rtog'i</option>
              <option value="brother" ${data.relationship === 'brother' ? 'selected' : ''}>Aka/uka</option>
              <option value="sister" ${data.relationship === 'sister' ? 'selected' : ''}>Opa/singil</option>
              <option value="other" ${data.relationship === 'other' || !data.relationship ? 'selected' : ''}>Boshqa</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Passport raqami</label>
            <input type="text" name="family_member_${index}_passport" class="form-control family-passport-input" placeholder="AA1234567" value="${data.passport_number || ''}">
          </div>
          <div class="col-md-3">
            <label class="form-label">Berilgan sana</label>
            <input type="text" name="family_member_${index}_passport_date" class="form-control family-date-input" placeholder="01.01.2020" data-date-mask="true" value="${data.passport_issue_date || ''}">
          </div>
          <div class="col-md-3">
            <label class="form-label">Tugash sanasi</label>
            <input type="text" name="family_member_${index}_passport_expiry_date" class="form-control family-date-input" placeholder="01.01.2030" data-date-mask="true" value="${data.passport_expiry_date || ''}">
          </div>
          <div class="col-md-3">
            <label class="form-label">Passport bergan tashkilot</label>
            <input type="text" name="family_member_${index}_passport_place" class="form-control" placeholder="MIB, IIB va h.k." value="${data.passport_issue_place || ''}">
          </div>
          <div class="col-md-4">
            <label class="form-label">Tug'ilgan sana</label>
            <input type="text" name="family_member_${index}_birth_date" class="form-control family-date-input" placeholder="01.01.2000" data-date-mask="true" value="${birthDateDisplay}">
          </div>
          <div class="col-md-6">
            <label class="form-label">Telefon raqam</label>
            <input type="text" name="family_member_${index}_phone" class="form-control family-phone-input" placeholder="+998 90 123 45 67" value="${data.phone || ''}">
          </div>
          <div class="col-md-6">
            <label class="form-label">Qo'shimcha ma'lumotlar</label>
            <input type="text" name="family_member_${index}_notes" class="form-control" value="${data.notes || ''}">
          </div>
        </div>
      </div>
    `;
    familyMembersContainer.appendChild(memberCard);

    // Remove button handler
    memberCard.querySelector(".remove-family-member").addEventListener("click", function() {
      memberCard.remove();
      toggleFamilyPlaceholder();
    });

    // Passport mask for family members
    const passportInput = memberCard.querySelector(`input[name="family_member_${index}_passport"]`);
    if (passportInput) {
      passportInput.addEventListener("input", (e) => {
        let v = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, "");
        let letters = v.slice(0, 2).replace(/[^A-Z]/g, "");
        let digits = v.slice(2).replace(/\D/g, "").slice(0, 7); // Maksimal 7 raqam
        e.target.value = letters + digits;
      });
    }

    // Date mask for family members
    const dateInputs = memberCard.querySelectorAll(".family-date-input");
    dateInputs.forEach(input => {
      input.addEventListener("input", function(e) {
        let value = e.target.value.replace(/\D/g, "");
        if (value.length >= 2) {
          value = value.slice(0, 2) + "." + value.slice(2);
        }
        if (value.length >= 5) {
          value = value.slice(0, 5) + "." + value.slice(5, 9);
        }
        e.target.value = value;
      });
    });

    // Phone format for family members
    const phoneInput = memberCard.querySelector(`input[name="family_member_${index}_phone"]`);
    if (phoneInput) {
      phoneInput.addEventListener("input", function(e) {
        let value = e.target.value.replace(/\D/g, "");
        if (value.startsWith("998")) {
          value = "+" + value;
        } else if (value.startsWith("8")) {
          value = "+998" + value.slice(1);
        } else if (value && !value.startsWith("+")) {
          value = "+998" + value;
        }
        // Format: +998 90 123 45 67
        if (value.length > 4) {
          value = value.slice(0, 4) + " " + value.slice(4);
        }
        if (value.length > 7) {
          value = value.slice(0, 7) + " " + value.slice(7);
        }
        if (value.length > 11) {
          value = value.slice(0, 11) + " " + value.slice(11);
        }
        if (value.length > 14) {
          value = value.slice(0, 14) + " " + value.slice(14, 16);
        }
        e.target.value = value;
      });
    }
  }

  if (addFamilyMemberBtn) {
    addFamilyMemberBtn.addEventListener("click", function() {
      addFamilyMember();
      toggleFamilyPlaceholder();
    });
  }

  // Remove passport image
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-passport-image') || e.target.closest('.remove-passport-image')) {
      const btn = e.target.classList.contains('remove-passport-image') ? e.target : e.target.closest('.remove-passport-image');
      const item = btn.closest('.passport-image-item');
      const deleteInput = item.querySelector('.delete-passport-input');
      if (deleteInput && !deleteInput.disabled) {
        deleteInput.disabled = true;
        item.style.opacity = '1';
        btn.textContent = 'O\'chirish';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-danger');
      } else if (deleteInput) {
        deleteInput.disabled = false;
        item.style.opacity = '0.5';
        btn.textContent = 'Qayta tiklash';
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-success');
      }
    }
    
    if (e.target.classList.contains('remove-completed-image') || e.target.closest('.remove-completed-image')) {
      const btn = e.target.classList.contains('remove-completed-image') ? e.target : e.target.closest('.remove-completed-image');
      const item = btn.closest('.completed-contract-image-item');
      const deleteInput = item.querySelector('.delete-completed-input');
      if (deleteInput && !deleteInput.disabled) {
        deleteInput.disabled = true;
        item.style.opacity = '1';
        btn.textContent = 'O\'chirish';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-danger');
      } else if (deleteInput) {
        deleteInput.disabled = false;
        item.style.opacity = '0.5';
        btn.textContent = 'Qayta tiklash';
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-success');
      }
    }

    if (e.target.classList.contains('remove-visa-image') || e.target.closest('.remove-visa-image')) {
      const btn = e.target.classList.contains('remove-visa-image') ? e.target : e.target.closest('.remove-visa-image');
      const item = btn.closest('.visa-image-item');
      const deleteInput = item.querySelector('.delete-visa-input');
      if (deleteInput && !deleteInput.disabled) {
        deleteInput.disabled = true;
        item.style.opacity = '1';
        btn.textContent = 'O\'chirish';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-danger');
      } else if (deleteInput) {
        deleteInput.disabled = false;
        item.style.opacity = '0.5';
        btn.textContent = 'Qayta tiklash';
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-success');
      }
    }
  });

  // Load existing family members
  {% if family_members %}
    {% for member in family_members %}
      addFamilyMember({
        first_name: "{% if member.first_name %}{{ member.first_name }}{% endif %}",
        last_name: "{% if member.last_name %}{{ member.last_name }}{% endif %}",
        middle_name: "{% if member.middle_name %}{{ member.middle_name }}{% endif %}",
        relationship: "{{ member.relationship|default:'other' }}",
        passport_number: "{% if member.passport_number %}{{ member.passport_number }}{% endif %}",
        passport_issue_date: "{% if member.passport_issue_date %}{{ member.passport_issue_date }}{% endif %}",
        passport_expiry_date: "{% if member.passport_expiry_date %}{{ member.passport_expiry_date }}{% endif %}",
        passport_issue_place: "{% if member.passport_issue_place %}{{ member.passport_issue_place }}{% endif %}",
        birth_date: "{% if member.birth_date %}{{ member.birth_date }}{% endif %}",
        phone: "{% if member.phone %}{{ member.phone }}{% endif %}",
        notes: "{% if member.notes %}{{ member.notes }}{% endif %}",
      });
    {% endfor %}
  {% endif %}

  // Agar mavjud bo'lmasa placeholder ko'rsatish
  toggleFamilyPlaceholder();

  // Telefon validatsiyasi
  const formEl = document.querySelector("form");
  function phoneDigits(val) {
    return (val || "").replace(/\D/g, "");
  }
  function validatePhones(e) {
    const primary = document.querySelector('input[name="phone_primary"]');
    const secondary = document.querySelector('input[name="phone_secondary"]');
    const primaryDigits = primary ? phoneDigits(primary.value) : "";
    if (primary && (primaryDigits.length !== 9 && primaryDigits.length !== 12)) {
      e.preventDefault();
      alert("Asosiy telefon raqamini to'liq kiriting (+998 XX XXX XX XX).");
      primary.focus();
      return false;
    }
    if (secondary) {
      let secondaryDigits = phoneDigits(secondary.value);
      if (secondaryDigits === "998") {
        secondaryDigits = "";
        secondary.value = "";
      }
      if (secondaryDigits && secondaryDigits.length !== 9 && secondaryDigits.length !== 12) {
        e.preventDefault();
        alert("Qo'shimcha telefon raqami to'liq bo'lishi kerak yoki bo'sh qoldiring.");
        secondary.focus();
        return false;
      }
    }
    return true;
  }
  if (formEl) {
    formEl.addEventListener("submit", validatePhones);
  }
});
</script>
{% endblock item %}

