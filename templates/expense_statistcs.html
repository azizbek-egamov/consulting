{% extends 'base.html' %}
{% load static %}

{% block title %}Chiqimlar statistikasi{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-0">
                        <i class="ri-bar-chart-line me-2"></i>
                        Chiqimlar statistikasi
                    </h2>
                    <p class="text-muted mb-0">Moliyaviy chiqimlar tahlili va hisobotlari</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" onclick="downloadPDF()">
                        <i class="ri-download-line me-1"></i>
                        PDF yuklab olish
                    </button>
                    <a href="{% url 'expense' %}" class="btn btn-outline-secondary">
                        <i class="ri-arrow-left-line me-1"></i>
                        Orqaga
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-danger bg-opacity-10 p-3 rounded">
                                <i class="ri-money-dollar-circle-line text-danger fs-4"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0 text-muted">Bugungi chiqim</h6>
                            <h4 class="mb-0">{{ today_expense|default:"0" }} so'm</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-warning bg-opacity-10 p-3 rounded">
                                <i class="ri-calendar-week-line text-warning fs-4"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0 text-muted">Haftalik chiqim</h6>
                            <h4 class="mb-0">{{ weekly_expense|default:"0" }} so'm</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-info bg-opacity-10 p-3 rounded">
                                <i class="ri-calendar-line text-info fs-4"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0 text-muted">Oylik chiqim</h6>
                            <h4 class="mb-0">{{ monthly_expense|default:"0" }} so'm</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-primary bg-opacity-10 p-3 rounded">
                                <i class="ri-bar-chart-line text-primary fs-4"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0 text-muted">Jami chiqim</h6>
                            <h4 class="mb-0">{{ total_expense|default:"0" }} so'm</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <!-- Monthly Expenses Chart -->
        <div class="col-xl-8 col-lg-7 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">Oylik chiqimlar dinamikasi</h5>
                </div>
                <div class="card-body">
                    <div id="monthlyChart" style="height: 350px;"></div>
                </div>
            </div>
        </div>

        <!-- Category Distribution Chart -->
        <div class="col-xl-4 col-lg-5 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">Kategoriyalar bo'yicha taqsimot</h5>
                </div>
                <div class="card-body">
                    <div id="categoryChart" style="height: 350px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Categories -->
    <div class="row mb-4">
        <div class="col-xl-6 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">Eng ko'p chiqim kategoriyalari</h5>
                </div>
                <div class="card-body">
                    {% if top_categories %}
                    <div class="list-group list-group-flush">
                        {% for category in top_categories %}
                        <div class="list-group-item border-0 px-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <div class="bg-primary bg-opacity-10 p-2 rounded me-3">
                                        <i class="ri-folder-line text-primary"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0">{{ category.name }}</h6>
                                        <small class="text-muted">{{ category.expense_count }} ta chiqim</small>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <h6 class="mb-0 text-danger">{{ category.total_amount|floatformat:0 }} so'm</h6>
                                    <small class="text-muted">{{ category.percentage|floatformat:1 }}%</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="ri-folder-line text-muted" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-2">Ma'lumot topilmadi</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Recent Expenses -->
        <div class="col-xl-6 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">So'nggi chiqimlar</h5>
                </div>
                <div class="card-body">
                    {% if recent_expenses %}
                    <div class="list-group list-group-flush">
                        {% for expense in recent_expenses %}
                        <div class="list-group-item border-0 px-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <div class="bg-danger bg-opacity-10 p-2 rounded me-3">
                                        <i class="ri-money-dollar-circle-line text-danger"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0">{{ expense.category.name }}</h6>
                                        <small class="text-muted">{{ expense.date|date:"d.m.Y H:i" }}</small>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <h6 class="mb-0 text-danger">{{ expense.amount|floatformat:0 }} so'm</h6>
                                    {% if expense.description %}
                                    <small class="text-muted text-truncate d-block" style="max-width: 150px;">
                                        {{ expense.description }}
                                    </small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="ri-money-dollar-circle-line text-muted" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-2">Chiqimlar topilmadi</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Statistics Table -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">Kategoriyalar bo'yicha batafsil statistika</h5>
                </div>
                <div class="card-body p-0">
                    {% if category_stats %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Kategoriya</th>
                                    <th>Chiqimlar soni</th>
                                    <th>Jami miqdor</th>
                                    <th>O'rtacha miqdor</th>
                                    <th>Eng katta chiqim</th>
                                    <th>Eng kichik chiqim</th>
                                    <th>Ulush (%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in category_stats %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="bg-primary bg-opacity-10 p-2 rounded me-2">
                                                <i class="ri-folder-line text-primary"></i>
                                            </div>
                                            <strong>{{ stat.name }}</strong>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary bg-opacity-10 text-primary">
                                            {{ stat.expense_count }}
                                        </span>
                                    </td>
                                    <td>
                                        <strong class="text-danger">{{ stat.total_amount|floatformat:0 }} so'm</strong>
                                    </td>
                                    <td>{{ stat.avg_amount|floatformat:0 }} so'm</td>
                                    <td>{{ stat.max_amount|floatformat:0 }} so'm</td>
                                    <td>{{ stat.min_amount|floatformat:0 }} so'm</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="progress flex-grow-1 me-2" style="height: 6px;">
                                                <div class="progress-bar" style="width: {{ stat.percentage }}%"></div>
                                            </div>
                                            <small>{{ stat.percentage|floatformat:1 }}%</small>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="ri-bar-chart-line text-muted" style="font-size: 4rem;"></i>
                        <h5 class="mt-3 text-muted">Statistika topilmadi</h5>
                        <p class="text-muted">Hozircha hech qanday chiqim qo'shilmagan</p>
                        <a href="{% url 'expense-create' %}" class="btn btn-primary">
                            <i class="ri-add-line me-1"></i>
                            Birinchi chiqimni qo'shish
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
// Monthly Expenses Chart
const monthlyChart = echarts.init(document.getElementById('monthlyChart'));
const monthlyOption = {
    tooltip: {
        trigger: 'axis',
        formatter: function(params) {
            return params[0].name + '<br/>' + 
                   params[0].seriesName + ': ' + 
                   params[0].value.toLocaleString() + ' so\'m';
        }
    },
    xAxis: {
        type: 'category',
        data: {{ monthly_labels|safe }}
    },
    yAxis: {
        type: 'value',
        axisLabel: {
            formatter: function(value) {
                return value.toLocaleString() + ' so\'m';
            }
        }
    },
    series: [{
        name: 'Chiqimlar',
        data: {{ monthly_data|safe }},
        type: 'line',
        smooth: true,
        areaStyle: {
            opacity: 0.3
        },
        itemStyle: {
            color: '#dc3545'
        },
        areaStyle: {
            color: {
                type: 'linear',
                x: 0,
                y: 0,
                x2: 0,
                y2: 1,
                colorStops: [{
                    offset: 0, color: 'rgba(220, 53, 69, 0.3)'
                }, {
                    offset: 1, color: 'rgba(220, 53, 69, 0.1)'
                }]
            }
        }
    }],
    grid: {
        left: '3%',
        right: '4%',
        bottom: '3%',
        containLabel: true
    }
};
monthlyChart.setOption(monthlyOption);

// Category Distribution Chart
const categoryChart = echarts.init(document.getElementById('categoryChart'));
const categoryOption = {
    tooltip: {
        trigger: 'item',
        formatter: function(params) {
            return params.name + '<br/>' + 
                   params.value.toLocaleString() + ' so\'m (' + 
                   params.percent + '%)';
        }
    },
    series: [{
        name: 'Kategoriyalar',
        type: 'pie',
        radius: ['40%', '70%'],
        avoidLabelOverlap: false,
        label: {
            show: false,
            position: 'center'
        },
        emphasis: {
            label: {
                show: true,
                fontSize: '18',
                fontWeight: 'bold'
            }
        },
        labelLine: {
            show: false
        },
        data: {{ category_chart_data|safe }}
    }]
};
categoryChart.setOption(categoryOption);

// Responsive charts
window.addEventListener('resize', function() {
    monthlyChart.resize();
    categoryChart.resize();
});

// PDF Download function
function downloadPDF() {
    window.location.href = '{% url "expense-statistics-pdf" %}';
}
</script>
{% endblock %}
